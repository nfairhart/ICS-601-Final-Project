@startuml

!define ENTITY_COLOR #E8F4F8
!define SERVICE_COLOR #FFF4E6
!define AGENT_COLOR #F0E8FF

' Database Models
class User <<Entity>> ENTITY_COLOR {
  +UUID id
  +string email
  +string full_name
  +string role (admin/editor/viewer)
  +datetime created_at
  +datetime updated_at
  --
  Relationships:
  +documents: List[Document]
  +permissions: List[DocumentPermission]
}

class Document <<Entity>> ENTITY_COLOR {
  +UUID id
  +string title
  +string description
  +UUID created_by
  +string status (draft/published/archived)
  +datetime created_at
  +datetime updated_at
  --
  Relationships:
  +creator: User
  +versions: List[DocumentVersion]
  +permissions: List[DocumentPermission]
}

class DocumentVersion <<Entity>> ENTITY_COLOR {
  +UUID id
  +UUID document_id
  +int version_number
  +string content (markdown)
  +string change_summary
  +UUID created_by
  +datetime created_at
  --
  Relationships:
  +document: Document
  +creator: User
}

class DocumentPermission <<Entity>> ENTITY_COLOR {
  +UUID id
  +UUID document_id
  +UUID user_id
  +string permission_type (view/edit/manage)
  +UUID granted_by
  +datetime created_at
  --
  Relationships:
  +document: Document
  +user: User
  +grantor: User
}

' Pydantic Schemas
class DocumentCreate <<Schema>> SERVICE_COLOR {
  +string title
  +string description
  +string content
}

class DocumentUpdate <<Schema>> SERVICE_COLOR {
  +Optional[string] title
  +Optional[string] description
  +Optional[string] content
  +Optional[string] change_summary
  +Optional[string] status
}

class SearchResult <<Schema>> SERVICE_COLOR {
  +string document_id
  +string version_id
  +string title
  +string content
  +float score
}

class UserCreate <<Schema>> SERVICE_COLOR {
  +string email
  +string full_name
  +string role
}

' AI/RAG Components
class RAGSystem <<Service>> AGENT_COLOR {
  -ChromaClient chroma_client
  -OpenAIEmbeddingFunction embedding_fn
  --
  +add_to_rag(doc_id, version_id, title, content)
  +search_rag(query, accessible_docs, top_k)
  +get_document_content(doc_id, version_id)
  +get_similar_documents(doc_id, top_k)
  +delete_from_rag(doc_id, version_id)
  +chunk_by_markdown_sections(text, max_chars)
}

class AIAgent <<Agent>> AGENT_COLOR {
  -Agent agent
  -string model = "openai:gpt-4o-mini"
  -string system_prompt
  --
  +run_agent(user_id, user_email, query): string
  --
  Tools:
  +search_documents(query, top_k)
  +list_user_documents(limit)
  +get_document_info(doc_id)
  +get_full_document_content(doc_id)
  +summarize_document(doc_id, max_length)
  +find_related_documents(doc_id, top_k)
  +compare_documents(doc_id_1, doc_id_2)
  +extract_key_points(doc_id, num_points)
  +answer_from_document(doc_id, question)
}

class AgentContext <<Context>> AGENT_COLOR {
  +UUID user_id
  +string user_email
  +List[string] accessible_doc_ids
}

' ChromaDB Representation
class ChromaCollection <<VectorStore>> AGENT_COLOR {
  +string name = "documents"
  +string space = "cosine"
  --
  Stored Data:
  +ids: List[string] (doc_id_version_id_chunkN)
  +embeddings: List[vector]
  +documents: List[string] (chunk text)
  +metadatas: List[dict]
}

' Relationships
User "1" -- "0..*" Document : creates >
User "1" -- "0..*" DocumentPermission : has >
User "1" -- "0..*" DocumentVersion : creates >

Document "1" -- "1..*" DocumentVersion : has versions >
Document "1" -- "0..*" DocumentPermission : controls access >

DocumentPermission "*" -- "1" User : grants access to >
DocumentPermission "*" -- "1" Document : controls >

AIAgent ..> AgentContext : uses
AIAgent ..> RAGSystem : queries
AIAgent ..> Document : retrieves via tools
AIAgent ..> DocumentPermission : checks access

RAGSystem ..> ChromaCollection : stores/queries
RAGSystem ..> DocumentVersion : indexes content

DocumentCreate ..> Document : creates
DocumentUpdate ..> DocumentVersion : creates new version
RAGSystem ..> SearchResult : returns

note right of AIAgent
  Pydantic AI agent with 10 tools
  for document operations.
  Maintains user context and
  enforces permissions.
end note

note right of RAGSystem
  Handles vector embeddings,
  chunking strategy, and
  semantic search using ChromaDB.
end note

note bottom of ChromaCollection
  Persistent vector store containing
  document chunk embeddings with
  metadata for filtering and retrieval.
end note

@enduml