@startuml
!define BACKEND_COLOR #E3F2FD
!define FRONTEND_COLOR #FFF3E0
!define DATA_COLOR #F3E5F5
!define AI_COLOR #E8F5E9

title Code Organization - Separation of Concerns

package "Backend Layer\n(FastAPI)" BACKEND_COLOR {

  [app.py] as App
  note right of App
    FastAPI application
    - API route definitions
    - CORS configuration
    - Startup/shutdown events
    - Session middleware
  end note

  package "Data Models" DATA_COLOR {
    [models.py] as Models
    note right of Models
      SQLAlchemy ORM models:
      - User
      - Document
      - DocumentVersion
      - DocumentPermission
    end note

    [schemas.py] as Schemas
    note right of Schemas
      Pydantic validation models:
      - UserCreate, UserUpdate
      - DocumentCreate, DocumentUpdate
      - SearchResult
      - PermissionCreate
    end note
  }

  package "Business Logic" {
    [database.py] as DB
    note right of DB
      Database configuration:
      - SQLAlchemy engine
      - SessionLocal factory
      - Base declarative class
    end note

    [utils.py] as Utils
    note right of Utils
      Helper functions:
      - get_current_user()
      - set_current_user()
      - Session management
    end note
  }

  package "AI/Agent Layer" AI_COLOR {
    [ai_agent.py] as Agent
    note right of Agent
      Pydantic AI agent:
      - Agent initialization
      - 10 tool definitions
      - AgentContext
      - run_agent() function
    end note

    [rag.py] as RAG
    note right of RAG
      RAG operations:
      - ChromaDB client
      - add_to_rag()
      - search_rag()
      - get_document_content()
      - get_similar_documents()
      - chunk_by_markdown_sections()
    end note
  }
}

package "Frontend Layer\n(FastHTML)" FRONTEND_COLOR {

  [main.py] as FrontendMain
  note right of FrontendMain
    FastHTML application:
    - Route definitions
    - Layout integration
    - Session handling
  end note

  package "Page Components" {
    [pages/users.py] as UsersPage
    [pages/documents.py] as DocsPage
    [pages/upload.py] as UploadPage
    [pages/search.py] as SearchPage
    [pages/permissions.py] as PermsPage
    [pages/agent.py] as AgentPage
  }

  package "Shared Components" {
    [shared/layout.py] as Layout
    note right of Layout
      Common UI elements:
      - Page layout
      - Navigation
      - Header/Footer
    end note
  }
}

package "Data Storage Layer" DATA_COLOR {
  database "SQLite Database\n(documents.db)" as SQLite {
    [users]
    [documents]
    [document_versions]
    [document_permissions]
  }

  database "ChromaDB\n(Vector Store)" as ChromaDB {
    collections [documents collection] as ChromaCollection
    note right of ChromaCollection
      Stores embeddings for:
      - Document chunks
      - Metadata (doc_id, version_id)
      - Section titles
    end note
  }
}

package "External Services" {
  cloud "OpenAI API" as OpenAI {
    [GPT-4o-mini\n(Agent LLM)]
    [text-embedding-3-small\n(Embeddings)]
  }
}

' Backend internal connections
App --> Models : uses
App --> Schemas : validates with
App --> DB : queries via
App --> Utils : uses
App --> Agent : calls run_agent()
App --> RAG : calls search/add

Agent --> RAG : uses for retrieval
Agent --> DB : queries database
Agent --> Models : accesses
Agent ..> OpenAI : API calls

RAG ..> OpenAI : embeddings
RAG --> ChromaDB : stores/queries

Models --> SQLite : ORM mapping
DB --> SQLite : connection

' Frontend connections
FrontendMain --> UsersPage : routes to
FrontendMain --> DocsPage : routes to
FrontendMain --> UploadPage : routes to
FrontendMain --> SearchPage : routes to
FrontendMain --> PermsPage : routes to
FrontendMain --> AgentPage : routes to

UsersPage --> Layout : uses
DocsPage --> Layout : uses
UploadPage --> Layout : uses
SearchPage --> Layout : uses
PermsPage --> Layout : uses
AgentPage --> Layout : uses

' Frontend to Backend connections
UsersPage ..> App : HTTP requests
DocsPage ..> App : HTTP requests
UploadPage ..> App : HTTP requests
SearchPage ..> App : HTTP requests
PermsPage ..> App : HTTP requests
AgentPage ..> App : HTTP requests

note bottom of SQLite
  Relational data storage:
  - User accounts
  - Document metadata
  - Permissions
  - Version history
end note

note bottom of ChromaDB
  Vector storage:
  - Document embeddings
  - Semantic search
  - Similarity matching
end note

legend right
  |= Color |= Layer |
  | <#E3F2FD> | Backend/API |
  | <#FFF3E0> | Frontend/UI |
  | <#F3E5F5> | Data Models |
  | <#E8F5E9> | AI/Agent |

  Separation of Concerns:
  - **Backend**: API endpoints, business logic
  - **Frontend**: User interface, pages
  - **Data Models**: Database schemas
  - **AI/Agent**: RAG, embeddings, LLM
  - **Storage**: SQLite + ChromaDB
end legend

@enduml
