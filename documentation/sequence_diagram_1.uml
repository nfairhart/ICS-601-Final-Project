@startuml
title Document Upload with RAG Indexing

actor User
participant "Frontend\n(FastHTML)" as Frontend
participant "Backend API\n(FastAPI)" as Backend
participant "Database\n(Supabase)" as Database
participant "RAG System\n(rag.py)" as RAG
participant "ChromaDB\n(Vector Store)" as Chroma

== Document Upload ==
User -> Frontend: Navigate to Upload Page
activate Frontend
Frontend --> User: Display upload form

User -> Frontend: Enter title, description, content\n(markdown format)
Frontend -> Backend: POST /api/documents\n{title, description, content}
activate Backend

Backend -> Backend: Validate request with\nDocumentCreate schema
Backend -> Backend: Get current user\nfrom session

== Database Storage ==
Backend -> Database: BEGIN Transaction
activate Database
Backend -> Database: INSERT INTO documents\n(id, title, description, created_by, status='draft')
Database --> Backend: Document ID

Backend -> Database: INSERT INTO document_versions\n(id, document_id, version_number=1, content)
Database --> Backend: Version ID

Backend -> Database: INSERT INTO document_permissions\n(document_id, user_id, permission_type='manage')
Database --> Backend: Permission ID
Backend -> Database: COMMIT Transaction
Database --> Backend: Success
deactivate Database

== RAG Indexing ==
Backend -> RAG: add_to_rag(document_id, version_id,\ntitle, content)
activate RAG
RAG -> RAG: chunk_by_markdown_sections(content)\n(max 2000 chars per chunk)
note right
  Intelligent chunking:
  - Preserves markdown structure
  - Keeps headings with content
  - Splits on section boundaries
end note

loop For each chunk
  RAG -> Chroma: Generate embedding via\nOpenAI text-embedding-3-small
  activate Chroma
  Chroma --> RAG: Embedding vector
  RAG -> Chroma: upsert(ids, documents, metadatas)
  note right
    Metadata includes:
    - document_id
    - version_id
    - title
    - chunk_index
    - section_title
  end note
  Chroma --> RAG: Chunk stored
  deactivate Chroma
end

RAG --> Backend: Indexed N chunks
deactivate RAG

== Response ==
Backend --> Frontend: 200 OK\n{document_id, version_id, title, status}
deactivate Backend
Frontend --> User: Show success message\nRedirect to document list
deactivate Frontend

@enduml